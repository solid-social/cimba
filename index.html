<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cimba - Decentralized Microblogging</title>

  <!-- SEO -->
  <meta name="description" content="A decentralized Twitter-style microblogging app where you own your data. Built on Solid.">
  <meta name="keywords" content="solid, decentralized, microblog, twitter, rdf, linked data">
  <meta name="author" content="Solid Social">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://solid-social.github.io/cimba/">
  <meta property="og:title" content="Cimba - Decentralized Microblogging">
  <meta property="og:description" content="A decentralized Twitter-style microblogging app where you own your data.">
  <meta property="og:image" content="https://solid-social.github.io/cimba/img/og-image.svg">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cimba - Decentralized Microblogging">
  <meta name="twitter:description" content="A decentralized Twitter-style microblogging app where you own your data.">

  <!-- Favicon -->
  <link rel="icon" href="favicon.png">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #000000;
      --bg-secondary: #16181c;
      --border: #2f3336;
      --text: #e7e9ea;
      --text-secondary: #71767b;
      --accent: #1d9bf0;
      --accent-hover: #1a8cd8;
      --danger: #f4212e;
      --success: #00ba7c;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* Layout */
    .layout {
      display: flex;
      max-width: 1280px;
      margin: 0 auto;
    }

    /* Sidebar */
    .sidebar {
      width: 275px;
      height: 100vh;
      position: sticky;
      top: 0;
      padding: 0 12px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      padding: 12px;
      font-size: 30px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 12px;
      border-radius: 9999px;
      font-size: 20px;
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s;
    }

    .nav-item:hover { background: var(--bg-secondary); }
    .nav-item.active { font-weight: 700; }
    .nav-icon { font-size: 26px; }

    .post-btn {
      width: 90%;
      padding: 16px;
      margin-top: 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 9999px;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }

    .post-btn:hover { background: var(--accent-hover); }

    .user-menu {
      margin-top: auto;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      border-radius: 9999px;
      cursor: pointer;
    }

    .user-menu:hover { background: var(--bg-secondary); }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }

    .user-info { flex: 1; }
    .user-name { font-weight: 700; font-size: 15px; }
    .user-handle { color: var(--text-secondary); font-size: 15px; }

    /* Main */
    .main {
      flex: 1;
      max-width: 600px;
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
      min-height: 100vh;
    }

    .header {
      position: sticky;
      top: 0;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(12px);
      padding: 0 16px;
      border-bottom: 1px solid var(--border);
      z-index: 10;
    }

    .header h1 {
      font-size: 20px;
      font-weight: 700;
      padding: 16px 0;
    }

    .header-tabs {
      display: flex;
    }

    .header-tab {
      flex: 1;
      padding: 16px;
      text-align: center;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 4px solid transparent;
      transition: all 0.2s;
    }

    .header-tab:hover { background: var(--bg-secondary); }
    .header-tab.active {
      color: var(--text);
      font-weight: 700;
      border-bottom-color: var(--accent);
    }

    /* Composer */
    .composer {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .composer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
    }

    .composer-content { flex: 1; }

    .composer-textarea {
      width: 100%;
      min-height: 52px;
      padding: 12px 0;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 20px;
      resize: none;
      outline: none;
    }

    .composer-textarea::placeholder { color: var(--text-secondary); }

    .composer-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .composer-tools {
      display: flex;
      gap: 4px;
    }

    .composer-tool {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: var(--accent);
      cursor: pointer;
    }

    .composer-tool:hover { background: rgba(29, 155, 240, 0.1); }

    .tweet-btn {
      padding: 8px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 9999px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    .tweet-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .tweet-btn:not(:disabled):hover { background: var(--accent-hover); }

    /* Tweet */
    .tweet {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tweet:hover { background: var(--bg-secondary); }

    .tweet-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .tweet-content { flex: 1; min-width: 0; }

    .tweet-header {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .tweet-name { font-weight: 700; }
    .tweet-handle { color: var(--text-secondary); }
    .tweet-dot { color: var(--text-secondary); }
    .tweet-time { color: var(--text-secondary); }

    .tweet-body {
      margin-top: 4px;
      font-size: 15px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .tweet-actions {
      display: flex;
      justify-content: space-between;
      max-width: 425px;
      margin-top: 12px;
    }

    .tweet-action {
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      margin: -8px;
      border-radius: 9999px;
      transition: all 0.2s;
    }

    .tweet-action:hover { color: var(--accent); background: rgba(29, 155, 240, 0.1); }
    .tweet-action.liked { color: #f91880; }
    .tweet-action.liked:hover { background: rgba(249, 24, 128, 0.1); }
    .tweet-action.retweeted { color: var(--success); }

    /* Right sidebar */
    .right-sidebar {
      width: 350px;
      padding: 0 32px;
    }

    .search-box {
      position: sticky;
      top: 0;
      padding: 12px 0;
      background: var(--bg);
    }

    .search-input {
      width: 100%;
      padding: 12px 20px;
      background: var(--bg-secondary);
      border: 1px solid transparent;
      border-radius: 9999px;
      color: var(--text);
      font-size: 15px;
      outline: none;
    }

    .search-input:focus { border-color: var(--accent); background: transparent; }

    .trends-box {
      background: var(--bg-secondary);
      border-radius: 16px;
      margin-top: 16px;
      overflow: hidden;
    }

    .trends-header {
      padding: 12px 16px;
      font-size: 20px;
      font-weight: 800;
    }

    .trend-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .trend-item:hover { background: rgba(255,255,255,0.03); }
    .trend-category { font-size: 13px; color: var(--text-secondary); }
    .trend-name { font-weight: 700; margin: 2px 0; }
    .trend-count { font-size: 13px; color: var(--text-secondary); }

    /* Login Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(91, 112, 131, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .modal {
      background: var(--bg);
      border-radius: 16px;
      padding: 32px;
      width: 400px;
      max-width: 90vw;
    }

    .modal h2 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .modal p {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .modal-input {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      font-size: 17px;
      margin-bottom: 24px;
      outline: none;
    }

    .modal-input:focus { border-color: var(--accent); }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-cancel {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 9999px;
      color: var(--text);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    .modal-submit {
      flex: 1;
      padding: 12px;
      background: var(--text);
      border: none;
      border-radius: 9999px;
      color: var(--bg);
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    /* Empty state */
    .empty-state {
      padding: 32px;
      text-align: center;
      color: var(--text-secondary);
    }

    .empty-state h3 {
      font-size: 31px;
      color: var(--text);
      margin-bottom: 8px;
    }

    /* Loading */
    .loading {
      padding: 32px;
      text-align: center;
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 1280px) {
      .right-sidebar { display: none; }
    }

    @media (max-width: 1000px) {
      .sidebar { width: 88px; }
      .nav-item span { display: none; }
      .post-btn span { display: none; }
      .post-btn { width: 50px; height: 50px; padding: 0; }
      .user-info { display: none; }
    }

    @media (max-width: 500px) {
      .sidebar { display: none; }
      .main { border: none; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Polyfill for crypto.randomUUID (needed for non-HTTPS)
    if (!crypto.randomUUID) {
      crypto.randomUUID = function() {
        return '10000000-1000-4000-8000-100000000000'.replace(/[018]/g, c =>
          (+c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> +c / 4).toString(16)
        )
      }
    }

    import { h, render } from 'https://esm.sh/preact@10.19.3'
    import { useState, useEffect } from 'https://esm.sh/preact@10.19.3/hooks'
    import htm from 'https://esm.sh/htm@3.1.1'
    import * as $rdf from 'https://esm.sh/rdflib@2.2.35'
    import { Session } from 'https://esm.sh/solid-oidc@0.0.3'

    const html = htm.bind(h)

    // RDF Namespaces
    const FOAF = $rdf.Namespace('http://xmlns.com/foaf/0.1/')
    const SIOC = $rdf.Namespace('http://rdfs.org/sioc/ns#')
    const DCT = $rdf.Namespace('http://purl.org/dc/terms/')
    const RDF = $rdf.Namespace('http://www.w3.org/1999/02/22-rdf-syntax-ns#')
    const PIM = $rdf.Namespace('http://www.w3.org/ns/pim/space#')

    // Auth
    let currentWebId = null
    let sessionReady = null

    const session = new Session({
      onStateChange: (e) => {
        currentWebId = e.detail.isActive ? e.detail.webId : null
        updateFetcher()
      }
    })

    async function initAuthEarly() {
      try { await session.restore() } catch (e) {}
      try { await session.handleRedirectFromLogin() } catch (e) {}
      currentWebId = session.webId
    }

    sessionReady = initAuthEarly()

    function getAuthFetch() {
      return session.webId
        ? (url, options) => session.authFetch(url, options)
        : fetch.bind(window)
    }

    const store = $rdf.graph()
    let fetcher = $rdf.fetcher(store, { fetch: getAuthFetch(), timeout: 30000 })

    function updateFetcher() {
      fetcher = $rdf.fetcher(store, { fetch: getAuthFetch(), timeout: 30000 })
    }

    async function solidLogin(idp) {
      const issuer = idp.startsWith('http') ? idp : `https://${idp}`
      await session.login(issuer, window.location.href)
    }

    async function initAuth() {
      await sessionReady
      updateFetcher()
      return session.webId ? { webId: session.webId } : null
    }

    async function doLogout() {
      await session.logout()
      currentWebId = null
      updateFetcher()
      window.location.reload()
    }

    // Profile
    async function fetchProfile(webId) {
      try {
        const docUrl = webId.split('#')[0]
        const res = await getAuthFetch()(docUrl, {
          headers: { 'Accept': 'text/turtle, application/ld+json, */*' }
        })
        const text = await res.text()
        const contentType = res.headers.get('content-type') || ''
        const mimeType = contentType.includes('json') ? 'application/ld+json' : 'text/turtle'
        $rdf.parse(text, store, docUrl, mimeType)

        const me = $rdf.sym(webId)
        const name = store.any(me, FOAF('name'))
        const avatar = store.any(me, FOAF('img')) || store.any(me, FOAF('depiction'))
        const storage = store.any(me, PIM('storage'))

        // Derive microblog channel from storage
        let mbspace = storage?.value
        if (mbspace) {
          mbspace = mbspace.replace(/\/?$/, '/') + 'public/microblog/'
        }

        return {
          webId,
          name: name?.value || 'Anonymous',
          handle: '@' + (webId.split('//')[1]?.split('/')[0] || 'user'),
          avatar: avatar?.value || `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(webId)}`,
          storage: storage?.value,
          mbspace
        }
      } catch (e) {
        console.error('Failed to fetch profile:', e)
        return {
          webId,
          name: 'Anonymous',
          handle: '@user',
          avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(webId)}`
        }
      }
    }

    // Posts
    async function fetchPosts(mbspace) {
      const posts = []
      if (!mbspace) return posts

      try {
        // Check last 30 days
        for (let i = 0; i < 30; i++) {
          const date = new Date()
          date.setDate(date.getDate() - i)
          const dayStr = date.toISOString().slice(0, 10)
          const dayFileUri = `${mbspace}${dayStr}.ttl`

          try {
            const head = await getAuthFetch()(dayFileUri, { method: 'HEAD' })
            if (!head.ok) continue
            await fetcher.load(dayFileUri)
          } catch (e) {}
        }

        const postNodes = store.each(null, RDF('type'), SIOC('Post'))

        for (const node of postNodes) {
          const content = store.any(node, SIOC('content'))
          const created = store.any(node, DCT('created'))
          const creator = store.any(node, SIOC('has_creator'))

          if (content) {
            let authorWebId = null
            let authorName = 'Unknown'
            let authorPic = null

            if (creator) {
              authorWebId = store.any(creator, SIOC('account_of'))?.value
              authorName = store.any(creator, FOAF('name'))?.value || 'Unknown'
              authorPic = store.any(creator, SIOC('avatar'))?.value
            }

            posts.push({
              id: node.value,
              content: content.value,
              created: created ? new Date(created.value) : new Date(),
              authorWebId,
              authorName,
              authorPic: authorPic || `https://api.dicebear.com/7.x/avataaars/svg?seed=${authorWebId || 'default'}`,
              authorHandle: authorWebId ? '@' + authorWebId.split('//')[1]?.split('/')[0] : '@unknown',
              likes: 0,
              retweets: 0,
              replies: 0
            })
          }
        }

        posts.sort((a, b) => b.created - a.created)
      } catch (e) {
        console.error('Failed to fetch posts:', e)
      }

      return posts
    }

    async function ensureContainer(uri) {
      const authFetch = getAuthFetch()
      try {
        const res = await authFetch(uri, { method: 'HEAD' })
        if (res.ok) return true
      } catch (e) {}

      const res = await authFetch(uri, {
        method: 'PUT',
        headers: {
          'Content-Type': 'text/turtle',
          'Link': '<http://www.w3.org/ns/ldp#BasicContainer>; rel="type"'
        }
      })
      return res.ok
    }

    async function createPost(mbspace, content, user) {
      const today = new Date().toISOString().slice(0, 10)
      const dayFileUri = `${mbspace}${today}.ttl`
      const now = new Date().toISOString()
      const postId = `#post-${Date.now()}`

      await ensureContainer(mbspace)

      const head = await getAuthFetch()(dayFileUri, { method: 'HEAD' })

      if (!head.ok) {
        // Create new file
        const turtle = `@prefix sioc: <http://rdfs.org/sioc/ns#>.
@prefix dct: <http://purl.org/dc/terms/>.
@prefix foaf: <http://xmlns.com/foaf/0.1/>.
@prefix xsd: <http://www.w3.org/2001/XMLSchema#>.

<${postId}> a sioc:Post ;
    sioc:content """${content.replace(/"/g, '\\"')}""" ;
    sioc:has_creator <${postId}-author> ;
    dct:created "${now}"^^xsd:dateTime .

<${postId}-author> a sioc:UserAccount ;
    sioc:account_of <${user.webId}> ;
    sioc:avatar <${user.avatar}> ;
    foaf:name "${user.name}" .
`
        await getAuthFetch()(dayFileUri, {
          method: 'PUT',
          headers: { 'Content-Type': 'text/turtle' },
          body: turtle
        })
      } else {
        // Append via PATCH
        const sparql = `INSERT DATA {
  <${postId}> a <http://rdfs.org/sioc/ns#Post> ;
    <http://rdfs.org/sioc/ns#content> """${content.replace(/"/g, '\\"')}""" ;
    <http://rdfs.org/sioc/ns#has_creator> <${postId}-author> ;
    <http://purl.org/dc/terms/created> "${now}"^^<http://www.w3.org/2001/XMLSchema#dateTime> .
  <${postId}-author> a <http://rdfs.org/sioc/ns#UserAccount> ;
    <http://rdfs.org/sioc/ns#account_of> <${user.webId}> ;
    <http://rdfs.org/sioc/ns#avatar> <${user.avatar}> ;
    <http://xmlns.com/foaf/0.1/name> "${user.name}" .
}`
        await getAuthFetch()(dayFileUri, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/sparql-update' },
          body: sparql
        })
      }

      return dayFileUri + postId
    }

    // Time formatting
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000)
      if (seconds < 60) return `${seconds}s`
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m`
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    }

    // Components
    function Sidebar({ user, onLogin, onLogout, onCompose }) {
      return html`
        <nav class="sidebar">
          <div class="logo">üê¶</div>

          <div class="nav-item active"><span class="nav-icon">üè†</span> <span>Home</span></div>
          <div class="nav-item"><span class="nav-icon">üîç</span> <span>Explore</span></div>
          <div class="nav-item"><span class="nav-icon">üîî</span> <span>Notifications</span></div>
          <div class="nav-item"><span class="nav-icon">‚úâÔ∏è</span> <span>Messages</span></div>
          <div class="nav-item"><span class="nav-icon">üìë</span> <span>Lists</span></div>
          <div class="nav-item"><span class="nav-icon">üë§</span> <span>Profile</span></div>
          <div class="nav-item"><span class="nav-icon">‚öôÔ∏è</span> <span>Settings</span></div>

          ${user ? html`
            <button class="post-btn" onClick=${onCompose}><span>Post</span></button>
            <div class="user-menu" onClick=${onLogout}>
              <img src=${user.avatar} class="user-avatar" />
              <div class="user-info">
                <div class="user-name">${user.name}</div>
                <div class="user-handle">${user.handle}</div>
              </div>
              <span>‚ãØ</span>
            </div>
          ` : html`
            <button class="post-btn" onClick=${onLogin}><span>Login</span></button>
          `}
        </nav>
      `
    }

    function Composer({ user, onPost }) {
      const [content, setContent] = useState('')

      const handlePost = () => {
        if (content.trim()) {
          onPost(content.trim())
          setContent('')
        }
      }

      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && e.ctrlKey && content.trim()) {
          handlePost()
        }
      }

      if (!user) return null

      return html`
        <div class="composer">
          <img src=${user.avatar} class="composer-avatar" />
          <div class="composer-content">
            <textarea
              class="composer-textarea"
              placeholder="What's happening?"
              value=${content}
              onInput=${e => setContent(e.target.value)}
              onKeyDown=${handleKeyDown}
              rows="1"
            />
            <div class="composer-actions">
              <div class="composer-tools">
                <div class="composer-tool">üì∑</div>
                <div class="composer-tool">üìä</div>
                <div class="composer-tool">üòÄ</div>
                <div class="composer-tool">üìÖ</div>
                <div class="composer-tool">üìç</div>
              </div>
              <button
                class="tweet-btn"
                disabled=${!content.trim()}
                onClick=${handlePost}
              >Post</button>
            </div>
          </div>
        </div>
      `
    }

    function Tweet({ post, onLike, onRetweet }) {
      return html`
        <article class="tweet">
          <img src=${post.authorPic} class="tweet-avatar" />
          <div class="tweet-content">
            <div class="tweet-header">
              <span class="tweet-name">${post.authorName}</span>
              <span class="tweet-handle">${post.authorHandle}</span>
              <span class="tweet-dot">¬∑</span>
              <span class="tweet-time">${timeAgo(post.created)}</span>
            </div>
            <div class="tweet-body">${post.content}</div>
            <div class="tweet-actions">
              <div class="tweet-action"><span>üí¨</span> ${post.replies || ''}</div>
              <div class="tweet-action ${post.retweeted ? 'retweeted' : ''}"><span>üîÅ</span> ${post.retweets || ''}</div>
              <div class="tweet-action ${post.liked ? 'liked' : ''}" onClick=${() => onLike?.(post.id)}><span>‚ù§Ô∏è</span> ${post.likes || ''}</div>
              <div class="tweet-action"><span>üì§</span></div>
            </div>
          </div>
        </article>
      `
    }

    function RightSidebar() {
      return html`
        <aside class="right-sidebar">
          <div class="search-box">
            <input type="text" class="search-input" placeholder="Search" />
          </div>

          <div class="trends-box">
            <div class="trends-header">Trends for you</div>
            <div class="trend-item">
              <div class="trend-category">Technology ¬∑ Trending</div>
              <div class="trend-name">#SolidProject</div>
              <div class="trend-count">2,847 posts</div>
            </div>
            <div class="trend-item">
              <div class="trend-category">Web ¬∑ Trending</div>
              <div class="trend-name">#DecentralizedWeb</div>
              <div class="trend-count">1,523 posts</div>
            </div>
            <div class="trend-item">
              <div class="trend-category">Technology ¬∑ Trending</div>
              <div class="trend-name">#LinkedData</div>
              <div class="trend-count">987 posts</div>
            </div>
          </div>
        </aside>
      `
    }

    function LoginModal({ onLogin, onClose }) {
      const [idp, setIdp] = useState('solidweb.org')

      return html`
        <div class="modal-overlay" onClick=${onClose}>
          <div class="modal" onClick=${e => e.stopPropagation()}>
            <h2>Sign in to Cimba</h2>
            <p>Enter your Solid identity provider</p>
            <input
              type="text"
              class="modal-input"
              placeholder="e.g. solidweb.org"
              value=${idp}
              onInput=${e => setIdp(e.target.value)}
            />
            <div class="modal-actions">
              <button class="modal-cancel" onClick=${onClose}>Cancel</button>
              <button class="modal-submit" onClick=${() => onLogin(idp)}>Sign in</button>
            </div>
          </div>
        </div>
      `
    }

    function App() {
      const [user, setUser] = useState(null)
      const [posts, setPosts] = useState([])
      const [showLogin, setShowLogin] = useState(false)
      const [loading, setLoading] = useState(true)
      const [activeTab, setActiveTab] = useState('for-you')

      useEffect(() => {
        async function init() {
          try {
            const session = await initAuth()
            if (session) {
              const profile = await fetchProfile(session.webId)
              setUser(profile)
              if (profile.mbspace) {
                const userPosts = await fetchPosts(profile.mbspace)
                setPosts(userPosts)
              }
            }
          } catch (e) {
            console.error('Init failed:', e)
          } finally {
            setLoading(false)
          }
        }
        init()
      }, [])

      const handleLogin = async (idp) => {
        setShowLogin(false)
        await solidLogin(idp)
      }

      const handlePost = async (content) => {
        if (!user?.mbspace) return
        try {
          await createPost(user.mbspace, content, user)
          const userPosts = await fetchPosts(user.mbspace)
          setPosts(userPosts)
        } catch (e) {
          console.error('Failed to post:', e)
        }
      }

      return html`
        <div class="layout">
          <${Sidebar}
            user=${user}
            onLogin=${() => setShowLogin(true)}
            onLogout=${doLogout}
            onCompose=${() => {}}
          />

          <main class="main">
            <header class="header">
              <h1>Home</h1>
              <div class="header-tabs">
                <div
                  class="header-tab ${activeTab === 'for-you' ? 'active' : ''}"
                  onClick=${() => setActiveTab('for-you')}
                >For you</div>
                <div
                  class="header-tab ${activeTab === 'following' ? 'active' : ''}"
                  onClick=${() => setActiveTab('following')}
                >Following</div>
              </div>
            </header>

            <${Composer} user=${user} onPost=${handlePost} />

            ${loading ? html`
              <div class="loading">Loading...</div>
            ` : posts.length > 0 ? posts.map(post => html`
              <${Tweet} key=${post.id} post=${post} />
            `) : user ? html`
              <div class="empty-state">
                <h3>Welcome to Cimba!</h3>
                <p>Post your first message above.</p>
              </div>
            ` : html`
              <div class="empty-state">
                <h3>Welcome to Cimba</h3>
                <p>Decentralized microblogging on Solid.<br/>Sign in to get started.</p>
              </div>
            `}
          </main>

          <${RightSidebar} />
        </div>

        ${showLogin && html`<${LoginModal} onLogin=${handleLogin} onClose=${() => setShowLogin(false)} />`}
      `
    }

    render(html`<${App} />`, document.getElementById('app'))
  </script>
</body>
</html>
